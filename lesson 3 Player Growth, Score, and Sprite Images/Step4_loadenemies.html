<!DOCTYPE html>
<html>
    <head>
        <title>Fishy Game</title>
        <script src="https://unpkg.com/kontra@10.0.2/kontra.js"></script>
        <style>
            canvas {
                display: block;
                margin: auto;
                background-color: #88ccee;
                border: 3px solid black;
            }
        </style>
    </head>
    <body>
        <canvas id="game" width="800" height="600"></canvas>

        <script>
            let {init, Sprite, GameLoop, initKeys, keyPressed, load, Text, assets} = kontra;
            let {canvas, context} = init('game');

            initKeys();

            kontra.load('background.png', 'player.png', 'enemysmall.png', 'enemybig.png').then(images => {     //Load ALL images at once

                let [backgroundImage, playerImage, enemySmallImage, enemyBigImage] = images;

                let background = Sprite({         //Background sprite
                    x: 0,
                    y: 0,
                    image: backgroundImage,
                    width: canvas.width,
                    height: canvas.height,
                    draw() {
                        this.context.drawImage(this.image, this.x, this.y, canvas.width, canvas.height);
                    }
                });

                let player = Sprite({       //Player sprite
                    x: 100,
                    y: 100,
                    width: 40,
                    height: 30,
                    image: playerImage,
                    size: 20,
                    update() {
                        if (keyPressed('arrowleft')) this.x -= 2;
                        if (keyPressed('arrowright')) this.x += 2;
                        if (keyPressed('arrowup')) this.y -= 2;
                        if (keyPressed('arrowdown')) this.y += 2;
                    },
                    draw() {
                        this.context.drawImage(this.image, this.x, this.y, this.width, this.height);
                    }
                });

                let enemies = [];

                function isoverlapping(min1, max1, min2, max2) {
                    return max1 >= min2 && max2 >= min1;
                }

                function iscolliding(sprite1, sprite2) {
                    return (
                        isoverlapping(sprite1.x, sprite1.x + sprite1.width, sprite2.x, sprite2.x + sprite2.width) &&
                        isoverlapping(sprite1.y, sprite1.y + sprite1.height, sprite2.y, sprite2.y + sprite2.height)
                    );
                }

                function createFish() {          //CREATE FISH USING IMAGES (instead of rectangles)   {
                    let size = Math.random() * 20 + 10;
                    let enemyImage = size < 25 ? enemySmallImage : enemyBigImage;

                    return Sprite({
                        x: canvas.width,
                        y: Math.random() * (canvas.height - size),
                        width: size,
                        height: size,
                        dx: -(Math.random() * 2 + 1),
                        image: enemyImage,
                        wasEaten: false,

                        update() {
                            this.advance();
                            if (this.x + this.width < 0) this.ttl = 0;

                            if (iscolliding(player, this) && !this.wasEaten) {
                                if (this.width * this.height < player.size * player.size) {
                                    this.wasEaten = true;
                                    player.size += 2;
                                    player.width = player.size;
                                    player.height = player.size;
                                    score += 1;
                                    this.ttl = 0;
                                }
                            }
                        },

                        draw() {
                            this.context.drawImage(this.image, this.x, this.y, this.width, this.height);
                        }
                    });
                }

                let spawnTimer = 60;
                let score = 0;

                let scoreText = Text({
                    text: 'Score: 0',
                    font: '20px Arial',
                    color: 'black',
                    x: 10,
                    y: 10
                });

                let loop = GameLoop({
                    update() {

                        spawnTimer--;
                        if (spawnTimer <= 0) {
                            enemies.push(createFish());   //now spawns IMAGE ENEMIES
                            spawnTimer = 60;
                        }

                        player.update();
                        enemies.forEach(e => e.update());
                        enemies = enemies.filter(e => e.isAlive());

                        scoreText.text = "Score: " + score;
                    },

                    render() {
                        background.draw();
                        player.draw();
                        enemies.forEach(e => e.draw());
                        scoreText.draw();
                    }
                });

                loop.start();
            });
        </script>
    </body>
</html>
